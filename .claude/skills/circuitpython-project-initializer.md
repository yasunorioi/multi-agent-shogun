# circuitpython-project-initializer

CircuitPython新規プロジェクトの初期ファイル一式を自動生成するスキル。

## 概要

用途・ボード種類・接続方式を指定するだけで、code.py、settings.toml、必要ライブラリリストを一括生成する。農業IoT（UECS）センサーノード、アクチュエータノードの開発を迅速に開始できる。

## 使用方法

```
/circuitpython-project-initializer [オプション]
```

### 入力パラメータ

| パラメータ | 必須 | 説明 | 選択肢 |
|-----------|------|------|--------|
| `--preset` | Yes | 用途プリセット | `sensor-wifi`, `sensor-ethernet`, `actuator`, `custom` |
| `--board` | Yes | ボード種類 | `pico2-wh`, `w5500-evb-pico`, `pico-w` |
| `--protocol` | No | 通信プロトコル | `uecs`, `mqtt`, `http` |
| `--sensors` | No | センサー種類（カンマ区切り） | `sht40`, `scd41`, `bmp280`, `bh1750` |
| `--output` | No | 出力ディレクトリ | デフォルト: `./circuitpy_project` |

## 用途別プリセット

### 1. sensor-wifi（WiFiセンサーノード）

Pico W / Pico 2 WH 向け。WiFi経由でセンサーデータを送信。

**生成ファイル:**
```
circuitpy_project/
├── code.py              # メインコード
├── settings.toml        # WiFi・UECS設定
├── lib/                 # ライブラリフォルダ
│   └── README.txt       # 必要ライブラリリスト
└── boot.py              # 起動設定（オプション）
```

**必要ライブラリ:**
- adafruit_requests.mpy
- adafruit_connection_manager.mpy
- adafruit_sht4x.mpy（SHT40使用時）
- adafruit_scd4x.mpy（SCD41使用時）
- adafruit_bmp280.mpy（BMP280使用時）
- adafruit_bus_device/
- adafruit_register/

### 2. sensor-ethernet（有線LANセンサーノード）

W5500-EVB-Pico / W5500-EVB-Pico2 向け。有線LAN経由でセンサーデータを送信。

**生成ファイル:**
```
circuitpy_project/
├── code.py              # メインコード（W5500初期化含む）
├── settings.toml        # ネットワーク・UECS設定
├── lib/
│   └── README.txt       # 必要ライブラリリスト
└── boot.py
```

**必要ライブラリ:**
- adafruit_wiznet5k/
- adafruit_sht4x.mpy
- adafruit_bus_device/
- adafruit_register/
- adafruit_ticks.mpy

### 3. actuator（アクチュエータノード）

リレー制御・バルブ制御向け。CCM受信→GPIO出力。

**生成ファイル:**
```
circuitpy_project/
├── code.py              # CCM受信・リレー制御
├── settings.toml        # ネットワーク・GPIO設定
├── lib/
│   └── README.txt
└── boot.py
```

**必要ライブラリ:**
- adafruit_wiznet5k/（Ethernet時）
- adafruit_ticks.mpy

## 出力ファイル構成

### code.py（sensor-wifi プリセット例）

```python
# ============================================================
# UECS Pico Sensor Node - WiFi Version
# Generated by circuitpython-project-initializer
# ============================================================

import time
import board
import busio
import wifi
import socketpool
import os

# センサーライブラリ
import adafruit_sht4x

# ============================================================
# 設定読み込み
# ============================================================
UECS_MULTICAST = os.getenv("UECS_MULTICAST", "224.0.0.1")
UECS_PORT = int(os.getenv("UECS_PORT", "16520"))
UECS_ROOM = int(os.getenv("UECS_ROOM", "1"))
UECS_REGION = int(os.getenv("UECS_REGION", "11"))
UECS_ORDER = int(os.getenv("UECS_ORDER", "2"))
UECS_PRIORITY = int(os.getenv("UECS_PRIORITY", "15"))
READ_INTERVAL = int(os.getenv("READ_INTERVAL", "10"))

# ============================================================
# ハードウェア初期化
# ============================================================
# I2C
i2c = busio.I2C(board.GP9, board.GP8)

# SHT40
sht = adafruit_sht4x.SHT4x(i2c)
sht.mode = adafruit_sht4x.Mode.NOHEAT_HIGHPRECISION

# WiFi接続
print("Connecting to WiFi...")
wifi.radio.connect(
    os.getenv("CIRCUITPY_WIFI_SSID"),
    os.getenv("CIRCUITPY_WIFI_PASSWORD")
)
print(f"Connected! IP: {wifi.radio.ipv4_address}")

# ソケットプール
pool = socketpool.SocketPool(wifi.radio)

# ============================================================
# UECS CCM生成
# ============================================================
def build_ccm(type_name, value, unit, room, region, order, priority):
    """UECS CCM XMLを生成"""
    return f'''<?xml version="1.0"?>
<UECS ver="1.00-E10">
<DATA type="{type_name}" room="{room}" region="{region}"
      order="{order}" priority="{priority}">{value}</DATA>
</UECS>'''

# ============================================================
# メインループ
# ============================================================
print("Starting sensor loop...")

while True:
    try:
        # センサー読み取り
        temperature = sht.temperature
        humidity = sht.relative_humidity

        print(f"Temp: {temperature:.1f}C, Humidity: {humidity:.1f}%")

        # CCM送信
        ccm_temp = build_ccm("InAirTemp.mIC", f"{temperature:.1f}", "C",
                            UECS_ROOM, UECS_REGION, UECS_ORDER, UECS_PRIORITY)
        ccm_humid = build_ccm("InAirHumid.mIC", f"{humidity:.1f}", "%",
                             UECS_ROOM, UECS_REGION, UECS_ORDER, UECS_PRIORITY)

        # UDP送信（マルチキャスト）
        sock = pool.socket(pool.AF_INET, pool.SOCK_DGRAM)
        sock.sendto(ccm_temp.encode(), (UECS_MULTICAST, UECS_PORT))
        sock.sendto(ccm_humid.encode(), (UECS_MULTICAST, UECS_PORT))
        sock.close()

    except Exception as e:
        print(f"Error: {e}")

    time.sleep(READ_INTERVAL)
```

### settings.toml（sensor-wifi プリセット例）

```toml
# ============================================================
# CircuitPython WiFi Sensor Node Settings
# Generated by circuitpython-project-initializer
# ============================================================

# WiFi設定
CIRCUITPY_WIFI_SSID = "YourSSID"
CIRCUITPY_WIFI_PASSWORD = "YourPassword"

# 固定IP設定（オプション - コメント解除で有効）
# CIRCUITPY_WIFI_IP_ADDRESS = "192.168.1.100"
# CIRCUITPY_WIFI_NETMASK = "255.255.255.0"
# CIRCUITPY_WIFI_GATEWAY = "192.168.1.1"

# UECS設定
UECS_MULTICAST = "224.0.0.1"
UECS_PORT = "16520"
UECS_ROOM = "1"
UECS_REGION = "11"
UECS_ORDER = "2"
UECS_PRIORITY = "15"

# センサー設定
READ_INTERVAL = "10"

# デバッグ
DEBUG = "false"
```

### code.py（sensor-ethernet プリセット例）

```python
# ============================================================
# UECS Pico Sensor Node - Ethernet Version (W5500)
# Generated by circuitpython-project-initializer
# ============================================================

import time
import board
import busio
import digitalio
import os

from adafruit_wiznet5k.adafruit_wiznet5k import WIZNET5K
import adafruit_wiznet5k.adafruit_wiznet5k_socket as socket

import adafruit_sht4x

# ============================================================
# 設定読み込み
# ============================================================
USE_DHCP = os.getenv("USE_DHCP", "false").lower() == "true"
STATIC_IP = os.getenv("STATIC_IP", "192.168.15.100")
SUBNET = os.getenv("SUBNET", "255.255.255.0")
GATEWAY = os.getenv("GATEWAY", "192.168.15.1")
DNS = os.getenv("DNS", "8.8.8.8")

UECS_MULTICAST = os.getenv("UECS_MULTICAST", "224.0.0.1")
UECS_PORT = int(os.getenv("UECS_PORT", "16520"))
UECS_ROOM = int(os.getenv("UECS_ROOM", "1"))
UECS_REGION = int(os.getenv("UECS_REGION", "11"))
UECS_ORDER = int(os.getenv("UECS_ORDER", "2"))
UECS_PRIORITY = int(os.getenv("UECS_PRIORITY", "15"))
READ_INTERVAL = int(os.getenv("READ_INTERVAL", "10"))

# ============================================================
# W5500初期化
# ============================================================
# SPIピン（W5500-EVB-Pico固定）
cs = digitalio.DigitalInOut(board.GP17)
spi = busio.SPI(board.GP18, MOSI=board.GP19, MISO=board.GP16)

print("Initializing W5500...")
eth = WIZNET5K(spi, cs)

# IP設定
if not USE_DHCP:
    def ip_tuple(ip_str):
        return tuple(int(x) for x in ip_str.split('.'))

    eth.ifconfig = (
        ip_tuple(STATIC_IP),
        ip_tuple(SUBNET),
        ip_tuple(GATEWAY),
        ip_tuple(DNS)
    )

print(f"IP Address: {eth.pretty_ip(eth.ip_address)}")
print(f"Link Status: {'UP' if eth.link_status else 'DOWN'}")

# ソケット初期化
socket.set_interface(eth)

# ============================================================
# センサー初期化
# ============================================================
i2c = busio.I2C(board.GP9, board.GP8)
sht = adafruit_sht4x.SHT4x(i2c)
sht.mode = adafruit_sht4x.Mode.NOHEAT_HIGHPRECISION

# ============================================================
# UECS CCM生成
# ============================================================
def build_ccm(type_name, value, room, region, order, priority):
    return f'''<?xml version="1.0"?>
<UECS ver="1.00-E10">
<DATA type="{type_name}" room="{room}" region="{region}"
      order="{order}" priority="{priority}">{value}</DATA>
</UECS>'''

# ============================================================
# メインループ
# ============================================================
print("Starting sensor loop...")

while True:
    try:
        temperature = sht.temperature
        humidity = sht.relative_humidity

        print(f"Temp: {temperature:.1f}C, Humidity: {humidity:.1f}%")

        ccm_temp = build_ccm("InAirTemp.mIC", f"{temperature:.1f}",
                            UECS_ROOM, UECS_REGION, UECS_ORDER, UECS_PRIORITY)
        ccm_humid = build_ccm("InAirHumid.mIC", f"{humidity:.1f}",
                             UECS_ROOM, UECS_REGION, UECS_ORDER, UECS_PRIORITY)

        # UDP送信
        sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        sock.sendto(ccm_temp.encode(), (UECS_MULTICAST, UECS_PORT))
        sock.sendto(ccm_humid.encode(), (UECS_MULTICAST, UECS_PORT))
        sock.close()

    except Exception as e:
        print(f"Error: {e}")

    time.sleep(READ_INTERVAL)
```

### code.py（actuator プリセット例）

```python
# ============================================================
# UECS Pico Actuator Node
# Generated by circuitpython-project-initializer
# ============================================================

import time
import board
import digitalio
import busio
import os

from adafruit_wiznet5k.adafruit_wiznet5k import WIZNET5K
import adafruit_wiznet5k.adafruit_wiznet5k_socket as socket

# ============================================================
# 設定読み込み
# ============================================================
STATIC_IP = os.getenv("STATIC_IP", "192.168.15.101")
SUBNET = os.getenv("SUBNET", "255.255.255.0")
GATEWAY = os.getenv("GATEWAY", "192.168.15.1")

UECS_PORT = int(os.getenv("UECS_PORT", "16520"))
UECS_ROOM = int(os.getenv("UECS_ROOM", "1"))

# GPIO設定
RELAY_PINS = [board.GP16, board.GP17, board.GP18, board.GP19]
ACTIVE_LOW = os.getenv("ACTIVE_LOW", "true").lower() == "true"

# CCMマッピング
CCM_MAPPING = {
    "Irri.sIC": 0,      # 灌水 → リレー0
    "Valve.sIC": 1,     # バルブ → リレー1
    "VenFan.sIC": 2,    # 換気扇 → リレー2
    "Relay.sIC": 3      # 汎用 → リレー3
}

# ============================================================
# W5500初期化
# ============================================================
cs = digitalio.DigitalInOut(board.GP17)
spi = busio.SPI(board.GP18, MOSI=board.GP19, MISO=board.GP16)

# 注意: アクチュエータノードではGP17をCSに使用するため、
# リレーピン配置を変更する必要がある場合あり

eth = WIZNET5K(spi, cs)

def ip_tuple(ip_str):
    return tuple(int(x) for x in ip_str.split('.'))

eth.ifconfig = (
    ip_tuple(STATIC_IP),
    ip_tuple(SUBNET),
    ip_tuple(GATEWAY),
    (8, 8, 8, 8)
)

print(f"IP: {eth.pretty_ip(eth.ip_address)}")
socket.set_interface(eth)

# ============================================================
# リレー初期化
# ============================================================
relays = []
for pin in RELAY_PINS:
    relay = digitalio.DigitalInOut(pin)
    relay.direction = digitalio.Direction.OUTPUT
    relay.value = ACTIVE_LOW  # 初期OFF（アクティブロー時はHIGH）
    relays.append(relay)

def set_relay(index, state):
    """リレー制御（state: True=ON, False=OFF）"""
    if 0 <= index < len(relays):
        if ACTIVE_LOW:
            relays[index].value = not state
        else:
            relays[index].value = state
        print(f"Relay {index}: {'ON' if state else 'OFF'}")

# ============================================================
# CCM受信・解析
# ============================================================
def parse_ccm(xml_data):
    """簡易CCMパーサー"""
    import re
    match = re.search(r'type="([^"]+)".*room="(\d+)".*>([^<]+)</DATA>', xml_data)
    if match:
        return {
            'type': match.group(1),
            'room': int(match.group(2)),
            'value': float(match.group(3))
        }
    return None

# ============================================================
# メインループ
# ============================================================
print("Starting actuator node...")

# UDP受信ソケット
sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
sock.bind(('', UECS_PORT))
sock.settimeout(1.0)

while True:
    try:
        data, addr = sock.recvfrom(1024)
        ccm = parse_ccm(data.decode())

        if ccm and ccm['room'] == UECS_ROOM:
            ccm_type = ccm['type']
            if ccm_type in CCM_MAPPING:
                relay_index = CCM_MAPPING[ccm_type]
                state = ccm['value'] > 0
                set_relay(relay_index, state)

    except socket.timeout:
        pass
    except Exception as e:
        print(f"Error: {e}")
```

### lib/README.txt（必要ライブラリリスト）

```
CircuitPython Required Libraries
================================
Generated by circuitpython-project-initializer

Download from: https://circuitpython.org/libraries

Preset: sensor-ethernet
Board: w5500-evb-pico

Required Libraries:
-------------------
[ ] adafruit_wiznet5k/        (folder)
[ ] adafruit_sht4x.mpy
[ ] adafruit_bus_device/      (folder)
[ ] adafruit_register/        (folder)
[ ] adafruit_ticks.mpy

Optional Libraries:
-------------------
[ ] adafruit_scd4x.mpy        (CO2 sensor)
[ ] adafruit_bmp280.mpy       (Pressure sensor)
[ ] adafruit_bh1750.mpy       (Light sensor)

Installation:
-------------
1. Download Adafruit CircuitPython Bundle
2. Extract and copy required libraries to CIRCUITPY/lib/
3. Verify all files are present

Bundle URL:
https://github.com/adafruit/Adafruit_CircuitPython_Bundle/releases
```

## サンプル出力

```
$ /circuitpython-project-initializer --preset sensor-ethernet --board w5500-evb-pico --sensors sht40,bmp280

CircuitPython Project Initializer
=================================

Preset: sensor-ethernet
Board: w5500-evb-pico
Sensors: sht40, bmp280
Protocol: uecs

Generating project files...

Created: ./circuitpy_project/
  - code.py (W5500 Ethernet sensor node)
  - settings.toml (Network & UECS config)
  - lib/README.txt (Required libraries list)
  - boot.py (Startup config)

Required Libraries:
  - adafruit_wiznet5k/
  - adafruit_sht4x.mpy
  - adafruit_bmp280.mpy
  - adafruit_bus_device/
  - adafruit_register/
  - adafruit_ticks.mpy

Next Steps:
1. Copy all files to CIRCUITPY drive
2. Download and install required libraries
3. Edit settings.toml with your network config
4. Restart device

Project ready!
```

## ボード別ピン配置リファレンス

### Pico W / Pico 2 WH

| 機能 | GPIO | 備考 |
|------|------|------|
| I2C SDA | GP8 | センサー |
| I2C SCL | GP9 | センサー |
| LED | GP25 | オンボード |
| Relay 0 | GP16 | アクチュエータ |
| Relay 1 | GP17 | アクチュエータ |
| Relay 2 | GP18 | アクチュエータ |
| Relay 3 | GP19 | アクチュエータ |

### W5500-EVB-Pico

| 機能 | GPIO | 備考 |
|------|------|------|
| W5500 CS | GP17 | 固定 |
| W5500 SCK | GP18 | 固定 |
| W5500 MOSI | GP19 | 固定 |
| W5500 MISO | GP16 | 固定 |
| I2C SDA | GP8 | センサー |
| I2C SCL | GP9 | センサー |
| LED | GP25 | オンボード |

## 用途

- **プロジェクト初期化**: 新規CircuitPythonプロジェクトの雛形生成
- **学習支援**: 動作するサンプルコードから学習開始
- **プロトタイピング**: センサーノード/アクチュエータノードの迅速な構築
- **標準化**: チーム内でのコード構成統一

## 注意事項

- CircuitPython 9.x 以降が必要（settings.tomlサポート）
- ボード専用のCircuitPython UF2を使用すること
- W5500使用時はSPIピンが固定のため、GPIO配置に注意
