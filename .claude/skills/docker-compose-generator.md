# Docker Compose Generator

プロジェクト要件からDocker Compose設定を自動生成するスキル。

## 概要

IoT/Webプロジェクト向けのDocker Compose構成を自動生成する。Node-RED + MQTT + DB構成等の頻出パターンに対応。docker-compose.yaml、設定ファイル、.env.example、起動手順READMEを一括生成。

## 使用方法

ユーザーが以下のいずれかを要求したら、このスキルを使用：

- Docker Compose設定の作成
- Node-RED + MQTT環境構築
- コンテナ環境のセットアップ
- IoT基盤のDocker化

## 入力パラメータ

### サービス選択

| サービス | 説明 | デフォルト |
|----------|------|-----------|
| mosquitto | MQTTブローカー | ✅ 有効 |
| node-red | Node-REDサーバー | ✅ 有効 |
| influxdb | 時系列DB | ❌ 無効 |
| postgres | PostgreSQL | ❌ 無効 |
| mysql | MySQL | ❌ 無効 |
| grafana | 可視化ダッシュボード | ❌ 無効 |
| redis | キャッシュ/メッセージキュー | ❌ 無効 |

### 設定オプション

| オプション | 説明 | デフォルト |
|-----------|------|-----------|
| project_name | プロジェクト名 | myproject |
| timezone | タイムゾーン | Asia/Tokyo |
| enable_auth | 認証有効化 | true |
| enable_tls | TLS有効化 | false |
| network_subnet | サブネット | 172.28.0.0/16 |

### ポート設定

| サービス | デフォルトポート |
|----------|-----------------|
| mosquitto | 1883 (MQTT), 9001 (WS) |
| node-red | 1880 |
| influxdb | 8086 |
| postgres | 5432 |
| mysql | 3306 |
| grafana | 3000 |
| redis | 6379 |

## 出力形式

生成するファイル：

```
project/
├── docker-compose.yaml     # メイン構成ファイル
├── .env.example            # 環境変数テンプレート
├── README.md               # 起動手順
├── mosquitto/
│   └── mosquitto.conf      # MQTT設定
├── node-red/
│   └── settings.js         # Node-RED設定（オプション）
└── data/                   # データディレクトリ
```

## サンプル出力

### IoTプロジェクト向け構成（Node-RED + MQTT + InfluxDB + Grafana）

#### docker-compose.yaml

```yaml
# IoT Project Docker Compose
# Project: farm-monitor
# Generated by docker-compose-generator skill
#
# Usage:
#   Start:  docker compose up -d
#   Stop:   docker compose down
#   Logs:   docker compose logs -f
#   Status: docker compose ps
#
# Access:
#   Node-RED:  http://localhost:1880
#   Grafana:   http://localhost:3000
#   InfluxDB:  http://localhost:8086
#   MQTT:      localhost:1883

services:
  # ========================================
  # Mosquitto - MQTT Broker
  # ========================================
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: farm-monitor-mqtt
    restart: unless-stopped
    ports:
      - "${MQTT_PORT:-1883}:1883"
      - "${MQTT_WS_PORT:-9001}:9001"
    volumes:
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log
    networks:
      - app-net
    healthcheck:
      test: ["CMD-SHELL", "mosquitto_sub -t '$$SYS/#' -C 1 -W 3 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ========================================
  # Node-RED - Control Logic
  # ========================================
  node-red:
    image: nodered/node-red:latest
    container_name: farm-monitor-nodered
    restart: unless-stopped
    depends_on:
      mosquitto:
        condition: service_healthy
    ports:
      - "${NODERED_PORT:-1880}:1880"
    environment:
      - TZ=${TZ:-Asia/Tokyo}
      - NODE_RED_ENABLE_PROJECTS=false
    volumes:
      - nodered_data:/data
    networks:
      - app-net
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:1880/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ========================================
  # InfluxDB - Time Series Database
  # ========================================
  influxdb:
    image: influxdb:2.7
    container_name: farm-monitor-influxdb
    restart: unless-stopped
    ports:
      - "${INFLUXDB_PORT:-8086}:8086"
    environment:
      - TZ=${TZ:-Asia/Tokyo}
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=${INFLUXDB_USER:-admin}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_PASSWORD:-changeme}
      - DOCKER_INFLUXDB_INIT_ORG=${INFLUXDB_ORG:-myorg}
      - DOCKER_INFLUXDB_INIT_BUCKET=${INFLUXDB_BUCKET:-sensors}
      - DOCKER_INFLUXDB_INIT_RETENTION=${INFLUXDB_RETENTION:-30d}
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - influxdb_config:/etc/influxdb2
    networks:
      - app-net

  # ========================================
  # Grafana - Visualization
  # ========================================
  grafana:
    image: grafana/grafana:latest
    container_name: farm-monitor-grafana
    restart: unless-stopped
    depends_on:
      - influxdb
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    environment:
      - TZ=${TZ:-Asia/Tokyo}
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - app-net

# ========================================
# Networks
# ========================================
networks:
  app-net:
    driver: bridge
    ipam:
      config:
        - subnet: ${NETWORK_SUBNET:-172.28.0.0/16}

# ========================================
# Volumes
# ========================================
volumes:
  mosquitto_data:
  mosquitto_log:
  nodered_data:
  influxdb_data:
  influxdb_config:
  grafana_data:
```

#### .env.example

```bash
# ========================================
# Project Configuration
# ========================================
PROJECT_NAME=farm-monitor
TZ=Asia/Tokyo

# ========================================
# Port Configuration
# ========================================
MQTT_PORT=1883
MQTT_WS_PORT=9001
NODERED_PORT=1880
INFLUXDB_PORT=8086
GRAFANA_PORT=3000

# ========================================
# InfluxDB Configuration
# ========================================
INFLUXDB_USER=admin
INFLUXDB_PASSWORD=changeme_secure_password
INFLUXDB_ORG=myorg
INFLUXDB_BUCKET=sensors
INFLUXDB_RETENTION=30d

# ========================================
# Grafana Configuration
# ========================================
GRAFANA_USER=admin
GRAFANA_PASSWORD=admin

# ========================================
# Network Configuration
# ========================================
NETWORK_SUBNET=172.28.0.0/16
```

#### mosquitto/mosquitto.conf

```conf
# Mosquitto Configuration
# Generated by docker-compose-generator

# ========================================
# General Settings
# ========================================
persistence true
persistence_location /mosquitto/data/
log_dest file /mosquitto/log/mosquitto.log
log_dest stdout
log_type all

# ========================================
# Default Listener (MQTT)
# ========================================
listener 1883
protocol mqtt

# Allow anonymous (development only)
# For production, set to false and configure authentication
allow_anonymous true

# ========================================
# WebSocket Listener (Optional)
# ========================================
listener 9001
protocol websockets

# ========================================
# Authentication (Production)
# ========================================
# Uncomment for password authentication:
# allow_anonymous false
# password_file /mosquitto/config/passwd

# ========================================
# TLS (Production)
# ========================================
# Uncomment for TLS:
# listener 8883
# protocol mqtt
# cafile /mosquitto/certs/ca.crt
# certfile /mosquitto/certs/server.crt
# keyfile /mosquitto/certs/server.key
# require_certificate false
```

#### README.md

```markdown
# Farm Monitor - Docker環境

## クイックスタート

### 1. 環境変数の設定

```bash
cp .env.example .env
# .envを編集してパスワード等を設定
```

### 2. 起動

```bash
docker compose up -d
```

### 3. アクセス

| サービス | URL | 認証情報 |
|----------|-----|---------|
| Node-RED | http://localhost:1880 | - |
| Grafana | http://localhost:3000 | admin / admin |
| InfluxDB | http://localhost:8086 | admin / (設定値) |
| MQTT | localhost:1883 | - |

## コマンド一覧

```bash
# 起動
docker compose up -d

# 停止
docker compose down

# ログ確認
docker compose logs -f

# 特定サービスのログ
docker compose logs -f node-red

# 再起動
docker compose restart

# データを含めて完全削除
docker compose down -v
```

## ディレクトリ構成

```
.
├── docker-compose.yaml   # メイン構成
├── .env                  # 環境変数
├── mosquitto/
│   └── mosquitto.conf    # MQTT設定
└── data/                 # データ永続化
```

## トラブルシューティング

### コンテナが起動しない

```bash
# ログを確認
docker compose logs [service_name]

# コンテナの状態を確認
docker compose ps -a
```

### ポートが競合する

`.env`でポート番号を変更:

```bash
NODERED_PORT=1881
MQTT_PORT=1884
```

### データをリセットしたい

```bash
docker compose down -v
docker compose up -d
```
```

## 構成パターン

### 1. 最小構成（MQTT + Node-RED）

```yaml
services:
  - mosquitto
  - node-red
```

用途: シンプルなIoTプロトタイプ

### 2. 標準構成（+ InfluxDB）

```yaml
services:
  - mosquitto
  - node-red
  - influxdb
```

用途: センサーデータの長期保存が必要な場合

### 3. フル構成（+ Grafana）

```yaml
services:
  - mosquitto
  - node-red
  - influxdb
  - grafana
```

用途: ダッシュボード表示が必要な場合

### 4. Web API構成（+ PostgreSQL）

```yaml
services:
  - node-red
  - postgres
  - redis
```

用途: REST API + RDB が必要な場合

## カスタマイズ例

### MQTT認証を有効化

mosquitto.confを編集:

```conf
allow_anonymous false
password_file /mosquitto/config/passwd
```

パスワードファイル作成:

```bash
docker compose exec mosquitto mosquitto_passwd -c /mosquitto/config/passwd username
```

### TLSを有効化

1. 証明書を配置: `./mosquitto/certs/`
2. mosquitto.confのTLSセクションをアンコメント
3. docker-compose.yamlでcertsボリュームをマウント

### Node-RED認証を有効化

1. settings.jsを作成
2. adminAuthセクションを設定
3. ボリュームマウントを追加

## 使用例

```
User: Node-REDとMQTTのDocker環境を作りたい
Assistant: [このスキルを使用して最小構成を生成]

User: センサーデータをグラフ表示したい、Docker Composeで
Assistant: [このスキルを使用してInfluxDB + Grafana付き構成を生成]

User: IoTプロジェクトのコンテナ環境を構築して
Assistant: [このスキルを使用して要件をヒアリングし、適切な構成を生成]
```
