# Home Assistant 農業向け初期設定スキル

農業向けHome Assistant環境の初期設定テンプレートを自動生成するスキル。

## 概要

温室・ハウス栽培向けのHome Assistant構成を自動生成する。MQTTセンサー、電磁弁制御、自動化ルール、ダッシュボードを含む完全な設定テンプレートを提供。Pico W/ESP32センサーノードとの連携を前提とした農業特化構成。

## 使用方法

ユーザーが以下のいずれかを要求したら、このスキルを使用：

- Home Assistant農業向け設定
- 温室制御システムのHome Assistant化
- 農業IoTプラットフォーム構築
- 灌水自動化システム設定
- ハウス環境モニタリング設定

## 入力パラメータ

### 基本設定

| パラメータ | 説明 | デフォルト |
|-----------|------|-----------|
| project_name | プロジェクト名 | my_farm |
| house_count | ハウス数 | 1 |
| timezone | タイムゾーン | Asia/Tokyo |
| latitude | 緯度（日出/日入計算用） | 35.6762 |
| longitude | 経度（日出/日入計算用） | 139.6503 |

### センサー構成

| センサー | CCM Type | 単位 | デフォルト |
|---------|----------|------|-----------|
| 温度 | InAirTemp | ℃ | ✅ 有効 |
| 湿度 | InAirHumid | % | ✅ 有効 |
| CO2 | InAirCO2 | ppm | ✅ 有効 |
| 照度 | InRadiation | lux | ❌ 無効 |
| 土壌温度 | SoilTemp | ℃ | ❌ 無効 |
| 土壌水分 | SoilWC | % | ❌ 無効 |
| 飽差 | InAirHD | g/m³ | ❌ 無効（計算値） |

### 制御対象

| アクチュエータ | 説明 | デフォルト |
|---------------|------|-----------|
| 灌水弁 | 電磁弁による灌水制御 | ✅ 有効 |
| 換気扇 | 換気ファン制御 | ❌ 無効 |
| 暖房機 | 暖房ON/OFF | ❌ 無効 |
| カーテン | 遮光カーテン開閉 | ❌ 無効 |
| 循環扇 | 空気循環ファン | ❌ 無効 |

### 自動化オプション

| オプション | 説明 | デフォルト |
|-----------|------|-----------|
| irrigation_timer | 灌水タイマー自動化 | ✅ 有効 |
| ventilation_auto | 温度連動換気 | ❌ 無効 |
| alert_notification | 異常値アラート通知 | ✅ 有効 |
| daily_report | 日次レポート生成 | ❌ 無効 |
| sunrise_sunset | 日出/日入連動制御 | ❌ 無効 |

## 出力ファイル構成

```
homeassistant/
├── configuration.yaml      # メイン設定ファイル
├── automations.yaml        # 自動化ルール
├── scripts.yaml            # スクリプト定義
├── sensors.yaml            # センサー定義（MQTTセンサー）
├── switches.yaml           # スイッチ定義（MQTTスイッチ）
├── groups.yaml             # グループ定義
├── lovelace/
│   └── dashboard.yaml      # ダッシュボード設定
└── README.md               # セットアップ手順
```

## サンプル出力

### configuration.yaml

```yaml
# Home Assistant 農業制御システム
# Project: my_farm
# Generated by homeassistant-agri-starter skill

homeassistant:
  name: 農場管理システム
  unit_system: metric
  temperature_unit: C
  time_zone: Asia/Tokyo
  latitude: 35.6762
  longitude: 139.6503

# ========================================
# ロガー設定
# ========================================
logger:
  default: info
  logs:
    homeassistant.components.mqtt: debug

# ========================================
# MQTT設定
# ========================================
mqtt:
  broker: 192.168.1.100  # MQTTブローカーのIP
  port: 1883
  # username: mqtt_user
  # password: mqtt_password
  discovery: true
  discovery_prefix: homeassistant

# ========================================
# センサー・スイッチの読み込み
# ========================================
sensor: !include sensors.yaml
switch: !include switches.yaml
automation: !include automations.yaml
script: !include scripts.yaml
group: !include groups.yaml

# ========================================
# 入力ヘルパー（設定値保存用）
# ========================================
input_number:
  irrigation_duration:
    name: 灌水時間
    min: 1
    max: 60
    step: 1
    unit_of_measurement: "分"
    icon: mdi:timer
    initial: 10

  temp_threshold_high:
    name: 高温警報閾値
    min: 20
    max: 45
    step: 0.5
    unit_of_measurement: "℃"
    icon: mdi:thermometer-alert
    initial: 35

  temp_threshold_low:
    name: 低温警報閾値
    min: 0
    max: 20
    step: 0.5
    unit_of_measurement: "℃"
    icon: mdi:thermometer-alert
    initial: 5

input_datetime:
  irrigation_time_1:
    name: 灌水時刻1
    has_date: false
    has_time: true
    initial: "06:00"

  irrigation_time_2:
    name: 灌水時刻2
    has_date: false
    has_time: true
    initial: "18:00"

input_boolean:
  irrigation_enabled:
    name: 灌水自動化有効
    icon: mdi:water-pump
    initial: true

  alert_enabled:
    name: アラート通知有効
    icon: mdi:bell
    initial: true

# ========================================
# 通知設定（LINE Notify等）
# ========================================
notify:
  - name: farm_notify
    platform: rest
    resource: https://notify-api.line.me/api/notify
    method: POST
    headers:
      Authorization: !secret line_notify_token
    message_param_name: message
```

### sensors.yaml

```yaml
# MQTTセンサー定義
# 1号棟センサー

# ========================================
# 温度センサー
# ========================================
- platform: mqtt
  name: "1号棟 温度"
  unique_id: h1_temperature
  state_topic: "farm/sensor/h1/temperature"
  unit_of_measurement: "℃"
  device_class: temperature
  value_template: "{{ value | float | round(1) }}"
  availability_topic: "farm/status/h1-sen"
  payload_available: "online"
  payload_not_available: "offline"
  device:
    identifiers: "pico_h1_sen"
    name: "1号棟センサーノード"
    manufacturer: "DIY"
    model: "Pico W Sensor"

# ========================================
# 湿度センサー
# ========================================
- platform: mqtt
  name: "1号棟 湿度"
  unique_id: h1_humidity
  state_topic: "farm/sensor/h1/humidity"
  unit_of_measurement: "%"
  device_class: humidity
  value_template: "{{ value | float | round(1) }}"
  availability_topic: "farm/status/h1-sen"
  device:
    identifiers: "pico_h1_sen"

# ========================================
# CO2センサー
# ========================================
- platform: mqtt
  name: "1号棟 CO2"
  unique_id: h1_co2
  state_topic: "farm/sensor/h1/co2"
  unit_of_measurement: "ppm"
  device_class: carbon_dioxide
  value_template: "{{ value | int }}"
  availability_topic: "farm/status/h1-sen"
  device:
    identifiers: "pico_h1_sen"

# ========================================
# 飽差（計算値）
# ========================================
- platform: template
  sensors:
    h1_vpd:
      friendly_name: "1号棟 飽差"
      unique_id: h1_vpd
      unit_of_measurement: "g/m³"
      value_template: >-
        {% set t = states('sensor.1_temperature') | float %}
        {% set rh = states('sensor.1_humidity') | float %}
        {% set svp = 6.1078 * (10 ** ((7.5 * t) / (t + 237.3))) %}
        {% set avp = svp * (rh / 100) %}
        {% set vpd = svp - avp %}
        {{ (vpd * 0.622 / (1.013 - vpd / 1000)) | round(2) }}
      icon_template: mdi:water-percent
```

### switches.yaml

```yaml
# MQTTスイッチ定義
# 1号棟アクチュエータ

# ========================================
# 灌水弁1
# ========================================
- platform: mqtt
  name: "1号棟 灌水弁1"
  unique_id: h1_valve1
  command_topic: "farm/actuator/h1/valve1/command"
  state_topic: "farm/actuator/h1/valve1/state"
  payload_on: "ON"
  payload_off: "OFF"
  state_on: "ON"
  state_off: "OFF"
  availability_topic: "farm/status/h1-act"
  payload_available: "online"
  payload_not_available: "offline"
  icon: mdi:water
  device:
    identifiers: "pico_h1_act"
    name: "1号棟アクチュエータノード"
    manufacturer: "DIY"
    model: "Pico W Actuator"

# ========================================
# 灌水弁2
# ========================================
- platform: mqtt
  name: "1号棟 灌水弁2"
  unique_id: h1_valve2
  command_topic: "farm/actuator/h1/valve2/command"
  state_topic: "farm/actuator/h1/valve2/state"
  payload_on: "ON"
  payload_off: "OFF"
  state_on: "ON"
  state_off: "OFF"
  availability_topic: "farm/status/h1-act"
  icon: mdi:water
  device:
    identifiers: "pico_h1_act"

# ========================================
# 灌水弁3
# ========================================
- platform: mqtt
  name: "1号棟 灌水弁3"
  unique_id: h1_valve3
  command_topic: "farm/actuator/h1/valve3/command"
  state_topic: "farm/actuator/h1/valve3/state"
  payload_on: "ON"
  payload_off: "OFF"
  state_on: "ON"
  state_off: "OFF"
  availability_topic: "farm/status/h1-act"
  icon: mdi:water
  device:
    identifiers: "pico_h1_act"

# ========================================
# 灌水弁4
# ========================================
- platform: mqtt
  name: "1号棟 灌水弁4"
  unique_id: h1_valve4
  command_topic: "farm/actuator/h1/valve4/command"
  state_topic: "farm/actuator/h1/valve4/state"
  payload_on: "ON"
  payload_off: "OFF"
  state_on: "ON"
  state_off: "OFF"
  availability_topic: "farm/status/h1-act"
  icon: mdi:water
  device:
    identifiers: "pico_h1_act"
```

### automations.yaml

```yaml
# 自動化ルール

# ========================================
# 灌水タイマー（朝）
# ========================================
- id: irrigation_morning
  alias: "灌水タイマー（朝）"
  description: "朝の定時灌水"
  trigger:
    - platform: time
      at: input_datetime.irrigation_time_1
  condition:
    - condition: state
      entity_id: input_boolean.irrigation_enabled
      state: "on"
  action:
    - service: script.irrigation_sequence
  mode: single

# ========================================
# 灌水タイマー（夕）
# ========================================
- id: irrigation_evening
  alias: "灌水タイマー（夕）"
  description: "夕方の定時灌水"
  trigger:
    - platform: time
      at: input_datetime.irrigation_time_2
  condition:
    - condition: state
      entity_id: input_boolean.irrigation_enabled
      state: "on"
  action:
    - service: script.irrigation_sequence
  mode: single

# ========================================
# 高温アラート
# ========================================
- id: high_temp_alert
  alias: "高温アラート"
  description: "設定温度を超えたら通知"
  trigger:
    - platform: template
      value_template: >-
        {{ states('sensor.1_temperature') | float >
           states('input_number.temp_threshold_high') | float }}
  condition:
    - condition: state
      entity_id: input_boolean.alert_enabled
      state: "on"
  action:
    - service: notify.farm_notify
      data:
        message: >-
          ⚠️ 高温警報
          1号棟温度: {{ states('sensor.1_temperature') }}℃
          閾値: {{ states('input_number.temp_threshold_high') }}℃
    - service: persistent_notification.create
      data:
        title: "高温警報"
        message: "1号棟の温度が {{ states('sensor.1_temperature') }}℃ に上昇しました"
        notification_id: high_temp_alert
  mode: single

# ========================================
# 低温アラート
# ========================================
- id: low_temp_alert
  alias: "低温アラート"
  description: "設定温度を下回ったら通知"
  trigger:
    - platform: template
      value_template: >-
        {{ states('sensor.1_temperature') | float <
           states('input_number.temp_threshold_low') | float }}
  condition:
    - condition: state
      entity_id: input_boolean.alert_enabled
      state: "on"
  action:
    - service: notify.farm_notify
      data:
        message: >-
          ⚠️ 低温警報
          1号棟温度: {{ states('sensor.1_temperature') }}℃
          閾値: {{ states('input_number.temp_threshold_low') }}℃
    - service: persistent_notification.create
      data:
        title: "低温警報"
        message: "1号棟の温度が {{ states('sensor.1_temperature') }}℃ に低下しました"
        notification_id: low_temp_alert
  mode: single

# ========================================
# センサー接続断アラート
# ========================================
- id: sensor_offline_alert
  alias: "センサー接続断アラート"
  description: "センサーノードがオフラインになったら通知"
  trigger:
    - platform: state
      entity_id: sensor.1_temperature
      to: "unavailable"
      for:
        minutes: 5
  condition:
    - condition: state
      entity_id: input_boolean.alert_enabled
      state: "on"
  action:
    - service: notify.farm_notify
      data:
        message: "⚠️ 1号棟センサーノードが5分以上オフラインです"
  mode: single
```

### scripts.yaml

```yaml
# スクリプト定義

# ========================================
# 灌水シーケンス（ウォーターハンマー防止）
# ========================================
irrigation_sequence:
  alias: "灌水シーケンス"
  description: "弁を順次開閉してウォーターハンマーを防止"
  sequence:
    # 弁1 開
    - service: switch.turn_on
      target:
        entity_id: switch.1_1
    - delay:
        seconds: "{{ states('input_number.irrigation_duration') | int * 60 }}"
    # 弁1 閉
    - service: switch.turn_off
      target:
        entity_id: switch.1_1
    - delay:
        seconds: 5  # 弁切り替え待機

    # 弁2 開
    - service: switch.turn_on
      target:
        entity_id: switch.1_2
    - delay:
        seconds: "{{ states('input_number.irrigation_duration') | int * 60 }}"
    # 弁2 閉
    - service: switch.turn_off
      target:
        entity_id: switch.1_2
    - delay:
        seconds: 5

    # 弁3 開
    - service: switch.turn_on
      target:
        entity_id: switch.1_3
    - delay:
        seconds: "{{ states('input_number.irrigation_duration') | int * 60 }}"
    # 弁3 閉
    - service: switch.turn_off
      target:
        entity_id: switch.1_3
    - delay:
        seconds: 5

    # 弁4 開
    - service: switch.turn_on
      target:
        entity_id: switch.1_4
    - delay:
        seconds: "{{ states('input_number.irrigation_duration') | int * 60 }}"
    # 弁4 閉
    - service: switch.turn_off
      target:
        entity_id: switch.1_4

    # 完了通知
    - service: notify.farm_notify
      data:
        message: "✅ 灌水シーケンス完了（1号棟）"
  mode: single

# ========================================
# 全弁緊急停止
# ========================================
emergency_stop:
  alias: "全弁緊急停止"
  description: "全ての電磁弁を即座に閉じる"
  sequence:
    - service: switch.turn_off
      target:
        entity_id:
          - switch.1_1
          - switch.1_2
          - switch.1_3
          - switch.1_4
    - service: notify.farm_notify
      data:
        message: "🛑 緊急停止: 全弁を閉じました"
  mode: single

# ========================================
# 手動灌水（単一弁）
# ========================================
manual_irrigation:
  alias: "手動灌水"
  description: "指定した弁で手動灌水"
  fields:
    valve_entity:
      description: "対象の弁エンティティ"
      example: "switch.1_1"
    duration_minutes:
      description: "灌水時間（分）"
      example: 5
  sequence:
    - service: switch.turn_on
      target:
        entity_id: "{{ valve_entity }}"
    - delay:
        minutes: "{{ duration_minutes | int }}"
    - service: switch.turn_off
      target:
        entity_id: "{{ valve_entity }}"
  mode: queued
  max: 4
```

### lovelace/dashboard.yaml

```yaml
# Lovelace ダッシュボード設定

title: 農場管理システム
views:
  # ========================================
  # メイン画面
  # ========================================
  - title: ダッシュボード
    path: main
    icon: mdi:view-dashboard
    badges: []
    cards:
      # 環境モニタリング
      - type: vertical-stack
        cards:
          - type: markdown
            content: "## 🌡️ 1号棟 環境"

          - type: horizontal-stack
            cards:
              - type: gauge
                entity: sensor.1_temperature
                name: 温度
                min: 0
                max: 50
                severity:
                  green: 15
                  yellow: 30
                  red: 35

              - type: gauge
                entity: sensor.1_humidity
                name: 湿度
                min: 0
                max: 100
                severity:
                  green: 40
                  yellow: 70
                  red: 85

              - type: gauge
                entity: sensor.1_co2
                name: CO2
                min: 0
                max: 2000
                severity:
                  green: 400
                  yellow: 1000
                  red: 1500

      # 灌水制御
      - type: vertical-stack
        cards:
          - type: markdown
            content: "## 💧 灌水制御"

          - type: entities
            entities:
              - entity: input_boolean.irrigation_enabled
                name: 自動灌水
              - entity: input_datetime.irrigation_time_1
                name: 朝の灌水時刻
              - entity: input_datetime.irrigation_time_2
                name: 夕の灌水時刻
              - entity: input_number.irrigation_duration
                name: 灌水時間

          - type: horizontal-stack
            cards:
              - type: button
                entity: switch.1_1
                name: 弁1
                icon: mdi:water
                tap_action:
                  action: toggle
              - type: button
                entity: switch.1_2
                name: 弁2
                icon: mdi:water
                tap_action:
                  action: toggle
              - type: button
                entity: switch.1_3
                name: 弁3
                icon: mdi:water
                tap_action:
                  action: toggle
              - type: button
                entity: switch.1_4
                name: 弁4
                icon: mdi:water
                tap_action:
                  action: toggle

          - type: horizontal-stack
            cards:
              - type: button
                name: 灌水開始
                icon: mdi:play
                tap_action:
                  action: call-service
                  service: script.irrigation_sequence
              - type: button
                name: 緊急停止
                icon: mdi:stop
                tap_action:
                  action: call-service
                  service: script.emergency_stop

      # アラート設定
      - type: vertical-stack
        cards:
          - type: markdown
            content: "## ⚠️ アラート設定"

          - type: entities
            entities:
              - entity: input_boolean.alert_enabled
                name: アラート通知
              - entity: input_number.temp_threshold_high
                name: 高温警報閾値
              - entity: input_number.temp_threshold_low
                name: 低温警報閾値

  # ========================================
  # 履歴画面
  # ========================================
  - title: 履歴
    path: history
    icon: mdi:chart-line
    cards:
      - type: history-graph
        title: 温度履歴（24時間）
        hours_to_show: 24
        entities:
          - sensor.1_temperature

      - type: history-graph
        title: 湿度履歴（24時間）
        hours_to_show: 24
        entities:
          - sensor.1_humidity

      - type: history-graph
        title: CO2履歴（24時間）
        hours_to_show: 24
        entities:
          - sensor.1_co2
```

### README.md

```markdown
# Home Assistant 農業制御システム セットアップガイド

## 前提条件

- Raspberry Pi 4 (2GB以上推奨)
- Home Assistant OS または Home Assistant Core
- MQTTブローカー（Mosquitto推奨）
- Pico W センサー/アクチュエータノード

## インストール手順

### 1. ファイル配置

```bash
# 設定ファイルをHome Assistantのconfigディレクトリにコピー
cp configuration.yaml /config/
cp sensors.yaml /config/
cp switches.yaml /config/
cp automations.yaml /config/
cp scripts.yaml /config/
cp groups.yaml /config/
mkdir -p /config/lovelace
cp lovelace/dashboard.yaml /config/lovelace/
```

### 2. secrets.yaml設定

```yaml
# /config/secrets.yaml
line_notify_token: "Bearer YOUR_LINE_NOTIFY_TOKEN"
```

### 3. MQTT設定の編集

`configuration.yaml`の`mqtt`セクションを環境に合わせて編集：

```yaml
mqtt:
  broker: 192.168.1.100  # MQTTブローカーのIPアドレス
  port: 1883
```

### 4. 設定の検証と再起動

Home Assistantの設定 > サーバー管理 > 設定の確認 で検証後、再起動。

## MQTTトピック構造

| トピック | 方向 | 説明 |
|---------|------|------|
| `farm/sensor/h1/temperature` | Pico→HA | 温度データ |
| `farm/sensor/h1/humidity` | Pico→HA | 湿度データ |
| `farm/sensor/h1/co2` | Pico→HA | CO2データ |
| `farm/actuator/h1/valve1/command` | HA→Pico | 弁制御コマンド |
| `farm/actuator/h1/valve1/state` | Pico→HA | 弁状態 |
| `farm/status/h1-sen` | Pico→HA | センサーノード状態 |
| `farm/status/h1-act` | Pico→HA | アクチュエータノード状態 |

## カスタマイズ

### ハウス追加

sensors.yaml, switches.yaml に h2, h3... を追加。
entity_id の `h1` を `h2` 等に変更。

### センサー追加

sensors.yaml に新しいセンサー定義を追加。

### 自動化追加

automations.yaml に新しいルールを追加。

## トラブルシューティング

### センサーが表示されない

1. MQTTブローカーへの接続を確認
2. トピック名が一致しているか確認
3. ログを確認: 設定 > ログ

### 自動化が動かない

1. 自動化が有効になっているか確認
2. 条件が満たされているか確認
3. 開発者ツール > 自動化 でテスト実行
```

## 構成パターン

### 1. 最小構成（センサー監視のみ）

```yaml
センサー:
  - 温度
  - 湿度
制御: なし
自動化:
  - 高温/低温アラート
```

用途: まずは環境モニタリングから始めたい場合

### 2. 標準構成（灌水制御付き）

```yaml
センサー:
  - 温度
  - 湿度
  - CO2
制御:
  - 灌水弁×4
自動化:
  - 灌水タイマー
  - 高温/低温アラート
```

用途: 灌水自動化を行いたい場合

### 3. フル構成（換気制御付き）

```yaml
センサー:
  - 温度
  - 湿度
  - CO2
  - 照度
  - 土壌水分
制御:
  - 灌水弁×4
  - 換気扇
  - 暖房機
自動化:
  - 灌水タイマー
  - 温度連動換気
  - 高温/低温アラート
  - 日出/日入連動
  - 日次レポート
```

用途: 完全な温室自動化

## 使用例

```
User: Home Assistantで温室の環境監視をしたい
Assistant: [このスキルを使用して最小構成を生成]

User: 灌水も自動化したい、Home Assistantで
Assistant: [このスキルを使用して標準構成を生成]

User: ハウスが3棟あるんだけど、Home Assistantの設定作って
Assistant: [このスキルを使用してhouse_count=3で生成]
```

## 関連スキル

- `docker-compose-generator`: Home Assistant + Mosquitto のDocker環境構築
- `pico-wifi-mqtt-template`: Pico Wセンサーノードのファームウェア
- `uecs-mqtt-bridge-generator`: UECS CCM ↔ MQTT ブリッジ
