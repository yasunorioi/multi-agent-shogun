# IoT Timer DB Generator

IoT/農業向けタイマー・スケジューラー用のSQLiteデータベーススキーマを自動生成するスキル。
SQLite と PostgreSQL の両方に対応。農業向け機能（日出/日入連動、8時間帯制御、シーケンス制御）を標準装備。

## 概要

Node-RED等のIoTプラットフォームで使用するタイマー機能用のDBスキーマを生成する。日出/日入連動、シーケンス制御、実行ログ等の農業IoTに必要な機能を網羅したテーブル設計を提供。

## 使用方法

ユーザーが以下のいずれかを要求したら、このスキルを使用：

- IoT用タイマーDBの設計
- スケジューラー用データベース作成
- Node-RED + SQLiteでタイマー管理
- 日出/日入連動タイマーのDB設計
- 灌水シーケンス制御用DB
- 農業用8時間帯タイマーDB

### コマンド形式

```
/iot-timer-db-generator <データベースタイプ> [オプション]
```

### パラメータ

| パラメータ | 説明 | 選択肢 |
|-----------|------|--------|
| DBタイプ | 対象データベース | `sqlite` / `postgresql` |
| --prefix | テーブルプレフィックス | デフォルト: なし |
| --agri | 農業向け機能有効化 | `true` / `false` |
| --timezone | タイムゾーン | デフォルト: `Asia/Tokyo` |
| --output | 出力ファイル | デフォルト: `stdout` |

## 機能選択

| 機能 | 説明 | デフォルト |
|------|------|-----------|
| basic_timers | 基本タイマーテーブル | ✅ 有効 |
| sequences | シーケンス制御テーブル | ✅ 有効 |
| sun_times | 日出/日入キャッシュ | ✅ 有効 |
| logs | 実行ログテーブル | ✅ 有効 |
| timeslots | 8時間帯設定テーブル | ✅ 有効（農業モード時） |

## テーブル構成（農業モード）

```
timer.db (SQLite)
├── timers              # タイマー定義（メイン）
├── timer_sequences     # シーケンス動作定義
├── timer_sequence_steps # シーケンスステップ
├── timer_logs          # 実行履歴ログ
├── sun_times           # 日出/日入時刻キャッシュ
└── timeslots           # 8時間帯設定（農業向け）
```

## ER図（農業モード）

```
┌─────────────────┐       ┌─────────────────────┐
│     timers      │       │  timer_sequences    │
├─────────────────┤       ├─────────────────────┤
│ id (PK)         │──┐    │ id (PK)             │
│ name            │  │    │ name                │
│ timer_type      │  │    │ repeat_count        │
│ start_type      │  │    │ timeout             │
│ start_time      │  │    └──────────┬──────────┘
│ start_offset    │  │               │
│ target_device   │  │               │ 1:N
│ action          │  │    ┌──────────▼──────────┐
│ sequence_id (FK)├──┼───>│timer_sequence_steps │
│ days_of_week    │  │    ├─────────────────────┤
└────────┬────────┘  │    │ id (PK)             │
         │           │    │ sequence_id (FK)    │
         │ 1:N       │    │ step_order          │
         │           │    │ target_device       │
┌────────▼────────┐  │    │ duration            │
│   timer_logs    │  │    │ delay_before        │
├─────────────────┤  │    │ delay_after         │
│ id (PK)         │  │    └─────────────────────┘
│ timer_id (FK)   │──┘
│ executed_at     │       ┌─────────────────────┐
│ status          │       │     sun_times       │
│ result_message  │       ├─────────────────────┤
└─────────────────┘       │ id (PK)             │
                          │ date (UNIQUE)       │
┌─────────────────┐       │ sunrise             │
│   timeslots     │       │ sunset              │
├─────────────────┤       │ solar_noon          │
│ id (PK)         │       └─────────────────────┘
│ slot_number     │
│ start_type      │
│ start_offset    │
│ target_temp     │
│ enabled         │
└─────────────────┘
```

## 出力形式

生成するファイル：

```
db/
├── schema.sql           # 完全なスキーマ定義
├── seed_data.sql        # サンプルデータ
├── maintenance.sql      # メンテナンス用SQL
└── README.md            # 使用方法
```

## SQLite スキーマ（農業モード）

```sql
-- ============================================================
-- IoT Timer Database Schema for SQLite (Agriculture Mode)
-- Generated by: iot-timer-db-generator
-- ============================================================
--
-- Usage:
--   sqlite3 timer.db < schema.sql
--
-- Features:
--   - Basic timers with fixed/sun-relative timing
--   - Sequence control for irrigation
--   - Sun times cache for sunrise/sunset calculation
--   - 8 timeslots for daily temperature control
--   - Execution logs with retention policy
-- ============================================================

PRAGMA foreign_keys = ON;
PRAGMA journal_mode = WAL;

-- ============================================================
-- timers: タイマー定義（メインテーブル）
-- ============================================================
CREATE TABLE IF NOT EXISTS timers (
    -- 基本情報
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    name            TEXT NOT NULL,
    description     TEXT,
    enabled         INTEGER DEFAULT 1,

    -- タイマー種別
    timer_type      TEXT NOT NULL DEFAULT 'simple',
    -- simple: 単発タイマー
    -- sequence: シーケンス動作
    -- sun_relative: 日出/日入連動

    -- 開始時刻設定
    start_type      TEXT NOT NULL DEFAULT 'fixed',
    -- fixed: 固定時刻 (HH:MM)
    -- sunrise: 日出 ± オフセット
    -- sunset: 日入 ± オフセット
    -- solar_noon: 南中 ± オフセット
    start_time      TEXT,                    -- HH:MM形式 (fixed時)
    start_offset    INTEGER DEFAULT 0,       -- 分単位オフセット

    -- 終了時刻設定
    end_type        TEXT,
    end_time        TEXT,
    end_offset      INTEGER DEFAULT 0,
    duration        INTEGER,                 -- 動作時間（秒）

    -- 曜日設定（ビットマスク: 日=1, 月=2, 火=4, ..., 土=64）
    days_of_week    INTEGER DEFAULT 127,     -- 127 = 毎日

    -- 制御対象
    target_device   TEXT NOT NULL,
    target_type     TEXT DEFAULT 'relay',
    action          TEXT NOT NULL DEFAULT 'ON',
    action_value    TEXT,

    -- シーケンス関連
    sequence_id     INTEGER,
    sequence_order  INTEGER,

    -- 灌水量調整（%）
    irrigation_rate INTEGER DEFAULT 100,

    -- メタデータ
    metadata        TEXT,                    -- JSON形式
    created_at      TEXT DEFAULT (datetime('now', 'localtime')),
    updated_at      TEXT DEFAULT (datetime('now', 'localtime')),

    FOREIGN KEY (sequence_id) REFERENCES timer_sequences(id) ON DELETE SET NULL
);

CREATE INDEX IF NOT EXISTS idx_timers_enabled ON timers(enabled);
CREATE INDEX IF NOT EXISTS idx_timers_target ON timers(target_device);
CREATE INDEX IF NOT EXISTS idx_timers_start_type ON timers(start_type);

-- ============================================================
-- timer_sequences: シーケンス定義
-- ============================================================
CREATE TABLE IF NOT EXISTS timer_sequences (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    name            TEXT NOT NULL,
    description     TEXT,
    enabled         INTEGER DEFAULT 1,
    repeat_count    INTEGER DEFAULT 1,       -- 繰り返し回数
    repeat_interval INTEGER DEFAULT 0,       -- 繰り返し間隔（秒）
    abort_on_error  INTEGER DEFAULT 1,       -- エラー時中断
    timeout         INTEGER DEFAULT 3600,    -- タイムアウト（秒）
    metadata        TEXT,
    created_at      TEXT DEFAULT (datetime('now', 'localtime')),
    updated_at      TEXT DEFAULT (datetime('now', 'localtime'))
);

-- ============================================================
-- timer_sequence_steps: シーケンスステップ
-- ============================================================
CREATE TABLE IF NOT EXISTS timer_sequence_steps (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    sequence_id     INTEGER NOT NULL,
    step_order      INTEGER NOT NULL,        -- 実行順序
    target_device   TEXT NOT NULL,
    action          TEXT NOT NULL DEFAULT 'ON',
    delay_before    INTEGER DEFAULT 0,       -- 実行前待機（秒）
    duration        INTEGER NOT NULL,        -- 動作時間（秒）
    delay_after     INTEGER DEFAULT 0,       -- 実行後待機（秒）
    description     TEXT,

    FOREIGN KEY (sequence_id) REFERENCES timer_sequences(id) ON DELETE CASCADE,
    UNIQUE (sequence_id, step_order)
);

CREATE INDEX IF NOT EXISTS idx_sequence_steps_order
    ON timer_sequence_steps(sequence_id, step_order);

-- ============================================================
-- timer_logs: 実行ログ
-- ============================================================
CREATE TABLE IF NOT EXISTS timer_logs (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    timer_id        INTEGER,
    sequence_id     INTEGER,
    executed_at     TEXT NOT NULL DEFAULT (datetime('now', 'localtime')),
    scheduled_at    TEXT,                    -- 予定時刻
    completed_at    TEXT,                    -- 完了時刻
    status          TEXT NOT NULL DEFAULT 'pending',
    -- pending: 待機中
    -- running: 実行中
    -- success: 成功
    -- failed: 失敗
    -- aborted: 中断
    -- skipped: スキップ
    result_code     INTEGER,
    result_message  TEXT,
    target_device   TEXT,
    action          TEXT,
    actual_duration INTEGER,                 -- 実際の動作時間（秒）
    sun_times       TEXT,                    -- その日の日出/日入（JSON）
    trigger_source  TEXT,                    -- トリガー元

    FOREIGN KEY (timer_id) REFERENCES timers(id) ON DELETE SET NULL,
    FOREIGN KEY (sequence_id) REFERENCES timer_sequences(id) ON DELETE SET NULL
);

CREATE INDEX IF NOT EXISTS idx_timer_logs_executed ON timer_logs(executed_at);
CREATE INDEX IF NOT EXISTS idx_timer_logs_status ON timer_logs(status);
CREATE INDEX IF NOT EXISTS idx_timer_logs_timer ON timer_logs(timer_id);

-- ============================================================
-- sun_times: 日出/日入キャッシュ
-- ============================================================
CREATE TABLE IF NOT EXISTS sun_times (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    date            TEXT NOT NULL,           -- YYYY-MM-DD
    latitude        REAL NOT NULL,
    longitude       REAL NOT NULL,
    sunrise         TEXT NOT NULL,           -- HH:MM:SS
    sunset          TEXT NOT NULL,           -- HH:MM:SS
    solar_noon      TEXT NOT NULL,           -- HH:MM:SS
    dawn            TEXT,                    -- 薄明開始
    dusk            TEXT,                    -- 薄明終了
    day_length      INTEGER,                 -- 日長（秒）
    calculated_at   TEXT DEFAULT (datetime('now', 'localtime')),

    UNIQUE (date, latitude, longitude)
);

CREATE INDEX IF NOT EXISTS idx_sun_times_date ON sun_times(date);

-- ============================================================
-- timeslots: 8時間帯設定（農業向け）
-- ============================================================
CREATE TABLE IF NOT EXISTS timeslots (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    name            TEXT NOT NULL,           -- 設定名（例: 夏期設定）
    slot_number     INTEGER NOT NULL CHECK (slot_number BETWEEN 1 AND 8),
    slot_name       TEXT,                    -- 時間帯名（例: 夜間前半）

    -- 開始時刻設定
    start_type      TEXT NOT NULL DEFAULT 'fixed',
    -- fixed: 固定時刻
    -- sunrise: 日出基準
    -- sunset: 日入基準
    -- solar_noon: 南中基準
    start_time      TEXT,                    -- HH:MM (fixed時)
    start_offset    INTEGER DEFAULT 0,       -- 分単位オフセット

    -- 温度設定
    target_temp     REAL,                    -- 目標温度（℃）
    temp_tolerance  REAL DEFAULT 1.0,        -- 許容誤差（℃）

    -- 湿度設定
    target_humidity REAL,                    -- 目標湿度（%）
    humidity_tolerance REAL DEFAULT 5.0,     -- 許容誤差（%）

    -- CO2設定
    target_co2      INTEGER,                 -- 目標CO2（ppm）

    -- 有効/無効
    enabled         INTEGER DEFAULT 1,

    -- メタデータ
    description     TEXT,
    created_at      TEXT DEFAULT (datetime('now', 'localtime')),
    updated_at      TEXT DEFAULT (datetime('now', 'localtime')),

    UNIQUE (name, slot_number)
);

CREATE INDEX IF NOT EXISTS idx_timeslots_name ON timeslots(name);

-- ============================================================
-- トリガー: updated_at 自動更新
-- ============================================================
CREATE TRIGGER IF NOT EXISTS update_timers_timestamp
    AFTER UPDATE ON timers
    FOR EACH ROW
BEGIN
    UPDATE timers SET updated_at = datetime('now', 'localtime')
    WHERE id = OLD.id;
END;

CREATE TRIGGER IF NOT EXISTS update_sequences_timestamp
    AFTER UPDATE ON timer_sequences
    FOR EACH ROW
BEGIN
    UPDATE timer_sequences SET updated_at = datetime('now', 'localtime')
    WHERE id = OLD.id;
END;

CREATE TRIGGER IF NOT EXISTS update_timeslots_timestamp
    AFTER UPDATE ON timeslots
    FOR EACH ROW
BEGIN
    UPDATE timeslots SET updated_at = datetime('now', 'localtime')
    WHERE id = OLD.id;
END;
```

## サンプルデータ（農業向け）

```sql
-- ============================================================
-- Sample Data for Agriculture IoT Timer Database
-- ============================================================

-- 日出/日入連動タイマー（朝灌水）
INSERT INTO timers (name, description, timer_type, start_type, start_offset,
                    duration, target_device, action, days_of_week)
VALUES ('朝灌水', '日出30分後に灌水開始', 'sun_relative', 'sunrise', 30,
        300, 'Irrigation', 'ON', 127);

-- 固定時刻タイマー（昼灌水）
INSERT INTO timers (name, description, timer_type, start_type, start_time,
                    duration, target_device, action, days_of_week)
VALUES ('昼灌水', '12時に灌水', 'simple', 'fixed', '12:00',
        300, 'Irrigation', 'ON', 127);

-- 日中換気（日出〜日入）
INSERT INTO timers (name, description, timer_type, start_type, start_offset,
                    end_type, end_offset, target_device, action, days_of_week)
VALUES ('日中換気', '日出1時間後から日入1時間前まで換気',
        'sun_relative', 'sunrise', 60, 'sunset', -60, 'VenFan', 'ON', 127);

-- 灌水シーケンス定義
INSERT INTO timer_sequences (name, description, repeat_count, timeout)
VALUES ('灌水シーケンス', 'ウォーターハンマー防止の順次灌水', 1, 1800);

-- シーケンスステップ
INSERT INTO timer_sequence_steps
    (sequence_id, step_order, target_device, action, delay_before, duration, delay_after, description)
VALUES
    (1, 1, 'Pump', 'ON', 0, 0, 5, 'ポンプ起動'),
    (1, 2, 'Valve1', 'ON', 0, 120, 3, '系統1灌水'),
    (1, 3, 'Valve1', 'OFF', 0, 0, 2, '系統1停止'),
    (1, 4, 'Valve2', 'ON', 0, 120, 3, '系統2灌水'),
    (1, 5, 'Valve2', 'OFF', 0, 0, 2, '系統2停止'),
    (1, 6, 'Valve3', 'ON', 0, 120, 3, '系統3灌水'),
    (1, 7, 'Valve3', 'OFF', 0, 0, 2, '系統3停止'),
    (1, 8, 'Pump', 'OFF', 5, 0, 0, 'ポンプ停止');

-- 8時間帯設定（夏期）
INSERT INTO timeslots (name, slot_number, slot_name, start_type, start_offset, target_temp, description)
VALUES
    ('夏期設定', 1, '夜間前半', 'sunset', 0, 22.0, '日入〜日入+4h 呼吸抑制期'),
    ('夏期設定', 2, '夜間後半', 'sunset', 240, 20.0, '日入+4h〜日出-2h 低温管理期'),
    ('夏期設定', 3, '明け方', 'sunrise', -120, 18.0, '日出-2h〜日出 最低温度期'),
    ('夏期設定', 4, '早朝', 'sunrise', 0, 22.0, '日出〜日出+2h 暖房開始期'),
    ('夏期設定', 5, '午前', 'sunrise', 120, 26.0, '日出+2h〜南中-2h 光合成活発期'),
    ('夏期設定', 6, '真昼', 'solar_noon', -120, 28.0, '南中-2h〜南中+2h 高温管理期'),
    ('夏期設定', 7, '午後', 'solar_noon', 120, 26.0, '南中+2h〜日入-2h 転流促進期'),
    ('夏期設定', 8, '夕方', 'sunset', -120, 24.0, '日入-2h〜日入 暖房停止準備');

-- 日出/日入キャッシュ（サンプル）
INSERT INTO sun_times (date, latitude, longitude, sunrise, sunset, solar_noon, day_length)
VALUES ('2026-02-05', 35.6762, 139.6503, '06:35:00', '17:25:00', '12:00:00', 39000);
```

## メンテナンス用SQL

```sql
-- ============================================================
-- Maintenance SQL for IoT Timer Database
-- ============================================================

-- 古いログ削除（30日以上前）
DELETE FROM timer_logs
WHERE executed_at < datetime('now', '-30 days', 'localtime');

-- 古い日出/日入キャッシュ削除（7日以上前）
DELETE FROM sun_times
WHERE date < date('now', '-7 days', 'localtime');

-- 過去7日の実行統計
SELECT
    status,
    COUNT(*) AS count,
    AVG(actual_duration) AS avg_duration
FROM timer_logs
WHERE executed_at > datetime('now', '-7 days', 'localtime')
GROUP BY status;

-- 8時間帯設定一覧
SELECT name, slot_number, slot_name, start_type, start_offset, target_temp
FROM timeslots
ORDER BY name, slot_number;

-- DB最適化
VACUUM;
ANALYZE;
```

## 曜日フラグ（days_of_week）

| ビット | 曜日 | 値 | 使用例 |
|--------|------|-----|--------|
| 0 | 日曜 | 1 | |
| 1 | 月曜 | 2 | |
| 2 | 火曜 | 4 | |
| 3 | 水曜 | 8 | |
| 4 | 木曜 | 16 | |
| 5 | 金曜 | 32 | |
| 6 | 土曜 | 64 | |
| - | 毎日 | 127 | 全ビットON |
| - | 平日 | 62 | 月〜金 |
| - | 週末 | 65 | 土日 |

## 8時間帯の農業的意義

| # | 時間帯 | 開始 | 農業的意義 |
|---|--------|------|-----------|
| 1 | 夜間前半 | 日入 | 呼吸抑制期 |
| 2 | 夜間後半 | 日入+4h | 低温管理期 |
| 3 | 明け方 | 日出-2h | 最低温度期 |
| 4 | 早朝 | 日出 | 暖房開始期 |
| 5 | 午前 | 日出+2h | 光合成活発期 |
| 6 | 真昼 | 南中-2h | 高温管理期 |
| 7 | 午後 | 南中+2h | 転流促進期 |
| 8 | 夕方 | 日入-2h | 暖房停止準備 |

## Node-REDでの曜日判定

```javascript
// 曜日判定関数
function isDayEnabled(flag, date) {
    const dayOfWeek = date.getDay(); // 0=日, 1=月, ...
    return (flag & (1 << dayOfWeek)) !== 0;
}
```

## 関連スキル

- [nodered-timeslot-generator](./nodered-timeslot-generator.md) - 8時間帯タイマー設定生成
- [docker-compose-generator](./docker-compose-generator.md) - Node-RED + SQLite環境構築

---

**Skill Version**: 2.0.0
**Created**: 2026-02-05
**Updated**: 2026-02-05 - 農業向け機能追加（8時間帯、灌水率調整）
