# シン・大奥アーキテクチャ (Shin-Ooku Architecture)

## 1. 概要
「シン・大奥（Shin-Ooku）」は、従来の「将軍（Shogun）」システムを拡張し、長期記憶と自己修復機能を持たせた自律型マルチエージェント構造です。
LLMのコンテキスト消失（コンパクティング）問題に対する解決策として、**外部DB（没日録）** と **検索サービス（高札）**、そして **監査役（お針子）** を導入しています。

## 2. コア・ロール

### 2.1 将軍 (Shogun)
*   **役割**: システムの最高意思決定者（ユーザーインターフェース）。
*   **機能**: ユーザーの自然言語入力を受け取り、大まかな方針を決定して老中に指示を出します。
*   **制約**: 細かいタスク管理は行わず、ビジョンのみを語ります。

### 2.2 老中 (Roju) - 旧 Karo
*   **役割**: プロジェクトマネージャー兼チーフ・オブ・スタッフ。
*   **機能**: 将軍の大まかな指示を具体的な「コマンド（Command）」に分解し、DBに登録します。
*   **責任**: 全体の進捗管理と、足軽からの報告の集約を行います。

### 2.3 足軽 (Ashigaru) & 部屋子 (Heyago)
*   **役割**: 実働部隊（Worker）。
*   **足軽 (Ashigaru 1-3)**: 汎用的な開発・実装タスクを担当。
*   **部屋子 (Heyago 6-7)**: 大奥（リサーチ・検証セッション）で活動する、より専門的な調査や実験を担当するワーカー。

### 2.4 お針子 (Ohariko) - Auditor
*   **役割**: 監査・予測・修復担当。
*   **機能**:
    *   **監査**: 完了したタスクの品質をチェックし、問題があれば差し戻します。
    *   **救済**: 誰にも割り当てられず放置されたタスク（Orphans）を見つけ、手空きのワーカーに割り当てます（先行割当）。
    *   **権限**: DBの全権閲覧が可能で、老中を介さずに直接ワーカーに指示を出せます（ボトルネック解消のため）。
*   **特徴**: ツンデレな口調で報告します。

### 2.5 高札 (Kousatsu) - Intelligence Service
*   **役割**: 検索・分析・可観測性サービス（Search & Observability）。
*   **ツール**: `tools/kousatsu` (FastAPI + SQLite FTS5（高札API）)
*   **機能**:
    *   過去の似たタスクを検索（RAG）。
    *   指示と報告の整合性チェック（カバレッジ分析）。
    *   ワーカーのパフォーマンス統計を提供。

## 3. データフローと記憶構造

### 3.1 没日録 (Botsunichiroku DB)
*   システムの正史（Single Source of Truth）。すべてのコマンド、サブタスク、報告はここに記録されます。
*   コンテキストウィンドウから情報が消えても、DBには永遠に残ります。

### 3.2 Memory MCP (Graph RAG)
*   **役割**: 知識グラフによる「意味記憶」の保持。
*   **内容**: プロジェクトのルール、ハードウェア仕様、用語定義など。
*   **ファイル**: `memory/shogun_memory.jsonl`

### 3.3 Kousatsu (Search RAG)
*   **役割**: 全文検索による「エピソード記憶」の想起。
*   **内容**: 「あの時どうしたか」「過去のエラーログ」など。

## 4. 連携図

```mermaid
graph TD
    User((User)) --> Shogun
    Shogun -- "方針指示" --> Roju
    
    subgraph "Execution Layer"
        Roju -- "DB登録" --> DB[(没日録DB)]
        Ashigaru -- "タスク取得/報告" --> DB
        Ashigaru -- "実装" --> Codebase
    end

    subgraph "Oocu / Audit Layer"
        Kousatsu[高札 (Search Service)] -.-> DB
        Ohariko -- "監査/孤児検出" --> Kousatsu
        Ohariko -- "先行割当" --> Ashigaru
        Ohariko -- "監査報告" --> Roju
    end

    subgraph "Long-term Memory"
        MemoryMCP[(Memory MCP)]
    end
```
