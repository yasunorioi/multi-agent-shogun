# 高札（Kousatsu）の役割と機能

## 1. 概要
**高札（Kousatsu）** は、マルチエージェントシステム「シン・大奥」における **検索・分析・可観測性サービス** です。
実体は `tools/kousatsu` にある FastAPI アプリケーションで、`ooku` セッション内で常駐稼働します。

## 2. 主な役割
高札は「行動する」エージェントではなく、「情報を提供する」インテリジェンス・サービスとして機能します。主に **お針子（Ohariko）** が監査や予測を行うためのデータソースとして利用されます。

*   **全文検索 (Full-Text Search)**: SQLiteのFTS5エンジンを用い、過去のタスクや報告を高速に検索します。
*   **異常検知 (Anomaly Detection)**: データ不整合や放置されたタスク（"orphans"）を自動検出します。
*   **品質監査支援 (Quality Assurance)**: 指示書と報告書のキーワード一致率（カバレッジ）を分析し、言及漏れを防ぎます。
*   **最適配置支援 (Resource Optimization)**: 足軽のパフォーマンス統計や得意分野を分析し、最適なタスク割当を提案します。

## 3. アーキテクチャ上の位置付け
*   **Read-Only**: 高札はデータベース（`botsunichiroku.db`）に対して **読み取り専用** です。書き込みは行いません。
*   **API提供**: HTTPサーバー (`localhost:8080`) として機能し、エージェント（主にお針子）は `curl` コマンドでAPIを叩いて情報を得ます。
*   **フォールバック**: 高札がダウンしていてもシステム（将軍・老中・足軽）は停止しません。お針子は「高札NG」モード（DB直接参照のみ）で最低限の監査を継続します。

## 4. 提供する機能 (API)

### 4.1 検索・分析系
*   **`GET /search`**: キーワードによる全文検索。類似タスクの過去事例を探すのに使用。
*   **`GET /search/similar`**: タスクIDを渡すだけで、類似の過去タスクを自動検索。

### 4.2 監査・品質系
*   **`GET /check/orphans`**: 矛盾・放置の検出。
    *   全サブタスク完了なのにPendingのコマンド
    *   7日以上放置されたPendingコマンド
    *   7日以上Assignedのままのサブタスク
    *   完了済みだが報告がないサブタスク
*   **`GET /check/coverage`**: カバレッジチェック。
    *   指示文（Command）と報告文（Report）の名詞を比較し、指示内容が報告で網羅されているかを数値化（`coverage_ratio`）。

### 4.3 統計・リソース系
*   **`GET /audit/history`**: 足軽ごとの監査合格率・却下率の履歴。
*   **`GET /worker/stats`**: 足軽のパフォーマンス統計（得意プロジェクト、平均完了時間）。先行割当（Preemptive Assignment）の判断材料になります。

## 5. お針子との連携
お針子の指示書 (`instructions/ohariko.md`) には「高札API連携」のセクションがあり、以下のフローで活用されます。

1.  **ヘルスチェック**: 監査開始時に `/health` を確認。
2.  **自動監査**: `/check/orphans` でシステム全体の異常を検知。
3.  **先行割当**: `/worker/stats` と `/search/similar` を組み合わせて、暇にしている足軽の中から「そのタスクが得意な者」を選定します。
4.  **品質チェック**: `/check/coverage` で報告の抜け漏れを機械的にチェックし、人間（足軽）のミスを減らします。

## 6. 効果検証：コンパクティング対策として
ユーザーの意図通り、高札は **「コンパクティング（コンテキスト消失）」対策として極めて有効** です。その理由は以下の「RAG（検索拡張生成）」的な構造にあります。

### 6.1 外部記憶としてのDB
LLMのコンテキストウィンドウ（短期記憶）は有限であり、会話が長引くと古い情報は「要約」（コンパクティング）され、詳細は失われます。
しかし、本システムでは「事実」や「経緯」を **没日録DB（SQLite）** という **外部記憶** に書き出しています。これはコンパクティングの影響を受けません。

### 6.2 検索による「想起」
高札の全文検索API（`/search`, `/search/similar`）は、失われた詳細情報を必要な時に **「想起」** するメカニズムです。
*   **Before**: 「あの時の件、どうだったっけ？」→ コンテキスト消失で思い出せない、または幻覚（ハルシネーション）を見る。
*   **After**: 「あの時の件」→ 高札で検索 → **正確な過去の記録（ID、担当者、結果）を再ロード** できる。

### 6.3 孤児タスク（Orphans）の救済
コンパクティングの最大の弊害は「頼んだタスクを忘れる」ことです。
高札の `/check/orphans` は、コンテキストから消え去った（忘れられた）が、DB上では未完了のまま残っているタスクを機械的に発見し、お針子に通知します。これにより **「忘れ去られたタスク」がゼロになります**。

## 7. 関連実装：Memory MCP（知識グラフRAG）
本システムには、高札とは異なるアプローチのもう一つのRAG実装が存在します。

*   **名称**: Memory MCP (`@modelcontextprotocol/server-memory`)
*   **データソース**: `memory/shogun_memory.jsonl`
*   **構造**: **ナレッジグラフ（知識グラフ）**
    *   Entity（実体）: プロジェクト、ハードウェア、ルール等の「名詞」
    *   Observation（観察事実）: それらに関する「事実」
*   **役割分担**:
    *   **高札 (Kousatsu)**: **「経緯・ログ」の検索**（フロー情報）。「あの時どうしたっけ？」というエピソード記憶。
    *   **Memory MCP**: **「知識・仕様」の格納**（ストック情報）。「PicoのIPは？」「切腹ルールとは？」という意味記憶。

この「高札（検索RAG）」と「Memory MCP（グラフRAG）」の **ハイブリッド構成** により、shogunシステムはコンパクティングに対して二重の防御壁を持っています。

## 8. まとめ
高札は「シン・大奥」における **「目」と「頭脳」のサポーター** です。
足軽が「手足」、老中が「指揮官」であるのに対し、高札は膨大なログとデータの中から「今どこに問題があるか」「誰に任せるのが最適か」というインサイトを計算し、お針子を通じてシステム全体にフィードバックします。
