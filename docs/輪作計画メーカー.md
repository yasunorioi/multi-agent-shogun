# 輪作計画メーカー 要件定義

## 目的
CSV（過去4年分の作付＋面積）を入力すると、将来N年（既定5年、UIで変更可）の作付計画を生成し、
1. ほ場×年（過去4年＋将来N年）の表
2. 年別の作物面積合計(ha)の表
3. 計画CSVのダウンロード

を出すGradioアプリを作る。来年以降もコピペで再利用できるよう、出力に過去4年も含める。

## 入力CSV
- ほ場ID/地区/ほ場名/area/過去年(例:R5,R6,R7,R8)... の列を想定（年列名はR数字）
- 面積は「a」入力（279→2.79ha）と「ha」入力の両方に対応（UIで単位選択）
- 過去作付は空欄（不明）があり得る。空欄でもエラーにせず処理する（UNKNOWN扱い）。
  UNKNOWNの扱いはラジオで選べる:
  - 制約をかけない（推奨）
  - 安全側（空欄があるほ場は、間隔制約がある作物を避ける等）

## UI
- 画面内の説明文に、テンプレCSVの"ダウンロードリンク"を置く（ボタン操作は不要）
  - template_example.csv と template_empty.csv を同梱・リンク表示
- 作物マスターをテキストで編集可能（改行区切り）
  初期値は:
  春小麦/秋小麦/大豆/デントコーン/WCS/てんさい/馬鈴薯/キャベツ/にんじん/だいこん
- 「上限・間隔」は、作物マスターに存在する作物だけ設定できれば良い。
  固定スライダー群ではなく、作物ごとの"制約テーブル"UI（Dataframe）で編集できるようにする。
  列: crop, cap_ha, min_gap_years, min_fields, max_fields
  作物マスター変更時はテーブルを自動更新（既存値は保持、新規作物はデフォルト行を追加）。

## デフォルト制約（制約テーブル初期値）
- cap_ha: 既定10ha（作物ごとに編集可）
  例外: WCS=4, 大豆=12, デントコーン=8
  てんさい/馬鈴薯はcap空欄(=無制限)でOK（必要なら入れられる）
- min_gap_years: てんさい=4, 馬鈴薯=4、他は0
- min_fields/max_fields: てんさいは min_fields=1（=てんさい0不可）, max_fields=2（既定）
  他は min=0, max=空欄(=無制限)

## 固定の禁止遷移（UIで説明も表示）
- てんさい→秋小麦 禁止（作期が重なるため物理的に不可）
  ※ビート 5-11月、秋小麦 9月播種→翌年7月末収穫
- 春小麦→秋小麦 禁止（病害対策）
- 同一作物の連作禁止（連続年はNG）

## 追加禁止遷移（任意入力）
- テキストボックスで「秋小麦->春小麦, 大豆->てんさい」のように追加指定できる。

## 優先遷移（加点）
- テキストで「from->to:weight」をカンマ区切りで入力可能。
- デフォルトの優先:
  - てんさい後：秋小麦 禁止 < 春小麦 < 大豆（= てんさい->大豆 を強く優先、てんさい->春小麦 を次点）
  - デント後：秋小麦 を優先（デントコーン->秋小麦）

## 最適化の方針
- OR-Tools等なしで、ヒューリスティック＋局所探索でOK。
- 目的関数:
  - 主作物（初期値: 春小麦,秋小麦,大豆）の年次面積変動をなるべく小さく
  - 優先遷移を満たすほど良い
  - てんさい/馬鈴薯は間隔を満たしつつ、可能ならより長く空けるほど良い（加点/減点のどちらでも良い）
- 生成不能時は理由（どの制約に引っかかったか）を表示。

## 納品物
- zip（rotation_planner_ui/以下にapp.py等）
- requirements.txt
- 実行方法README（pip install -r requirements.txt → python app.py）
- 個人データは同梱しない（例データは汎用のダミーのみ）

